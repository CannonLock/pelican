# Serve a Pelican Cache

A [Pelican](http://pelicanplatform.org/) *Cache* creates a cache that connects to a Pelican data federation to allow faster data access. It stores data that is accessed via a pelican origin in a cache until it gets evicted. The cache has the potential to both be faster and physically closer to your location than your origin. This allows for faster data access when running complex workflows.

This document contains instructions on how to serve a Pelican cache.

## Before Starting

### Install Pelican

If you haven't installed Pelican, follow the instructions to [install pelican](/install.mdx).

For _Linux_ users, it is recommended to install Pelican using one of the package managers (RPM, APK, Deb, etc.) so that Pelican dependencies are automatically handled. You may also run a [Pelican docker image](./install/docker.mdx) to serve a Pelican cache.
If you prefer to install Pelican as a standalone binary, you need to follow [additional instructions](https://osg-htc.org/docs/data/xrootd/install-standalone/#install-xrootd-standalone) to install dependencies for the Pelican cache.

> Note that serving a Pelican cache with a standalone Pelican binary is possible, but not recommended or supported.

For _macOS_ and _Windows_ users who want to serve a Pelican cache, please use [Pelican docker image](./install/docker.mdx).

### Open Firewall Port for Pelican Cache

The Pelican cache listens to two TCP ports for file transfers and Web UI. By default, the file transfer port is at `8442` and the Web UI and APIs port is at `8444`. If your server has firewall policy in place, please open the two ports for both incoming the outgoing TCP requests to allow the Pelican cache to function as expected.

You may change the port numbers through the [configuration file](./parameters.mdx) with parameter [`Cache.Port`](./parameters.mdx#Cache-Port) and [`Server.WebPort`](./parameters.mdx#Server-WebPort) respectively.

> If it is not possible for you to expose any port through the firewall, Pelican has a special feature called _Connection Broker_, where it allows you to serve a Pelican cache without a public-accessible port and any TLS credential files in place. However, this is an experimental feature and requires the Pelican federation you are joining to be compatible. If you are interested in learning more about _Connection Broker_, please contact help@pelicanplatform.org for further instructions.

### Prepare TLS Credentials

Pelican servers use `https` for serving its web UI and handling internal http requests. `https` requires a set of credential files in place to work, including:

- A valid TLS certificate
- The private key associated with the certificate
- The Intermediate Certificate or the chain file, that establishes the trust chain to a root certificate

> For local development and testing, you may skip setting up TLS credentials by setting configuration parameter `TLSSkipVerify` to `true`. You should **NOT** set this for production.

You need to contact a Certificate Authority (CA) who owns the root certificate for getting these credentials. One popular CA that provides free TLS certificates is [Let's Encrypt](https://letsencrypt.org/). You may follow [their guide](https://letsencrypt.org/getting-started/) to obtain the credentials listed above. **Note that you need to have a valid domain before proceeding.**

Once you go through the process, locate your credential files and set the following parameters to the file locations or copy the credential files to the default locations of the parameters:

- `Server.TLSCertificate`
  - The certicate file from Let's Encrypt (or another CA), usually named as `example.com.crt` or `example.com.pem`
  - Default location: `~/.config/pelican/certificates/tls.crt` for non-root users or `/etc/pelican/certificates/tls.crt` for root users.

- `Server.TLSKey`
  - The private key corresponding to the TLS certificate, usually named as `example.com.key`.
  - Default location: `~/.config/pelican/certificates/tls.key` for non-root users or `/etc/pelican/certificates/tls.key` for root users.

- `Server.TLSCACertificateFile`
  - The intermediate certificate from Let's Encrypt to establish the trust chain to a root certificate, usually named as `letsencrypt-intermediate.pem` or `chain.pem`
  - Default location: `~/.config/pelican/certificates/tlsca.pem` for non-root users or `/etc/pelican/certificates/tlsca.pem` for root users.

Since your TLS certificate is associated with your domain name, you will need to change the default hostname of Pelican server to be consistent. Set `Server.Hostname` to your domain name (e.g. `example.com`).

## Serve a Cache

> If you are running Pelican docker image to serve a cache, please refer to the [docker image documentation](./install/docker.mdx#run-pelican-cache-server).

### Find a federation to join

Before serving a cache, you need to find a Pelican federation to join in. If you are unfamiliar with the term **federation**, refer to [Useful Terminology](./client-usage.mdx#useful-terminology) before proceeding.

If you don't have a federation in mind, the Open Science Data Federation (OSDF) is an example Pelican federation that you can join in for testing purposes. If you are interesting in serving an OSDF cache, refer to the [OSDF website](https://osg-htc.org/) for details.

The federation discovery URL for OSDF is `osg-htc.org`. You may use this as your `<federation>` argument in the next section when launching your origin.

### Launch the Cache

To launch a pelican cache, run:

```bash
pelican cache serve -f <federation> 
```

Where:

* `<federation>` is the URL to the federation the cache will be joining

This will start a Pelican cache as a daemon process.

### Additional arguments to launch a Cache

This section documents the additional arguments you can pass to the command above to run the cache.

* **-h or --help**: Output documentation on the `serve` command and its arguments.
* **-p or --port**: Set the port at which the Pelican admin website should be accessible.

* **--config**: Set the location of the configuration file.
* **-d or --debug**: Enable the debugging mode, allowing for more verbose log
* **-l or --log**: Set the location of the file where log messages should be redirected to and not output the the console.

There are other configurations available to modify via the configuration file. Refer to the [Parameters page](./parameters.mdx) for details.

## Test CacheFunctionality

Once you have your cache set up, follow the steps below to test if your cache can access a file through a Pelican federation. 

1. Have data available that is accessible via an origin. Since a cache only works with data available via an origin that’s in the same data federation, the following assumes that you have a an accessible namespace within the same data federation. For more information on how to set that up, refer to [Serving an Origin](./serving_an_origin.mdx). Ensure there is some public file available.
2. Curl the director for the test file and ensure that the url used is the cache that you set up. Assuming your directory is `/tmp/demo`, run the following command to curl your known public file from the cache. 
``` $ curl -v https://<cache-url>/<namespace/path-to-public-file> ```  Where: 
* `<cache-url>` is the of your cache
* `<namespace/path-to-public-file> is the namespace and the path of the known public file  
Check that the curl output contains the data from the public file.


Congratulations! You have finished setting up and running your cache.
